<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Director de Orquesta - Versi√≥n Universal</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #0d0d0d; 
            color: #e0e0e0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px;
        }
        
        .main-container { width: 100%; max-width: 640px; }

        /* Video Stage */
        .stage { 
            position: relative; 
            width: 100%; 
            padding-bottom: 75%; 
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #333;
            margin-bottom: 20px;
        }

        video, canvas { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            transform: scaleX(-1); object-fit: cover;
        }

        /* Panel de Control */
        .controls {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #333;
        }

        /* Bot√≥n Start */
        #btn-start {
            background: #00e676;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 800;
            border-radius: 50px;
            cursor: pointer;
            margin: 15px 0;
            display: none; 
            box-shadow: 0 0 15px rgba(0, 230, 118, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Consola de Diagn√≥stico */
        .console-log {
            background: #000;
            color: #00ff00;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: left;
            height: 120px;
            overflow-y: auto;
            border-left: 3px solid #00e676;
            white-space: pre-wrap;
        }

        /* Barras */
        .bars-area { display: flex; gap: 10px; margin-top: 15px; }
        .metric { flex: 1; background: #222; padding: 10px; border-radius: 8px; }
        .bar-track { height: 8px; background: #444; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .bar-val { height: 100%; width: 0%; transition: width 0.1s; }
        #vol-val { background: #29b6f6; }
        #spd-val { background: #ffa726; }

    </style>

    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div class="main-container">
        <h1>üéµ Director de Orquesta V5</h1>

        <div class="controls">
            <!-- Aceptamos CUALQUIER audio para evitar bloqueos -->
            <input type="file" id="audioFile" accept="audio/*">
            
            <button id="btn-start">‚ñ∂ INICIAR ORQUESTA</button>

            <!-- Reproductor nativo visible -->
            <audio id="audioPlayer" controls style="width: 100%; margin-top:15px;"></audio>
            
            <div id="console" class="console-log">Inicializando sistema...</div>
        </div>

        <div class="bars-area">
            <div class="metric">
                <small>Volumen (Izq)</small>
                <div class="bar-track"><div id="vol-val" class="bar-val"></div></div>
                <span id="vol-txt">100%</span>
            </div>
            <div class="metric">
                <small>Velocidad (Der)</small>
                <div class="bar-track"><div id="spd-val" class="bar-val"></div></div>
                <span id="spd-txt">1.0x</span>
            </div>
        </div>

        <div class="stage">
            <video id="input_video" playsinline muted autoplay></video>
            <canvas id="output_canvas"></canvas>
        </div>
    </div>

<script>
    // --- REFERENCIAS ---
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const audioPlayer = document.getElementById('audioPlayer');
    const btnStart = document.getElementById('btn-start');
    const consoleDiv = document.getElementById('console');
    
    // UI Refs
    const volBar = document.getElementById('vol-val');
    const volTxt = document.getElementById('vol-txt');
    const spdBar = document.getElementById('spd-val');
    const spdTxt = document.getElementById('spd-txt');

    // Estado L√≥gico
    let prevX = 0, prevY = 0;
    let currVol = 1, currSpd = 1;
    let targetVol = 1, targetSpd = 1;
    const LERP = 0.1;

    // --- SISTEMA DE LOGS ---
    function log(msg, type="info") {
        const time = new Date().toLocaleTimeString();
        let color = "#00ff00"; // Info verde
        if(type === "error") color = "#ff4444"; // Error rojo
        if(type === "warn") color = "#ffbb33"; // Warning naranja
        if(type === "sys") color = "#00ffff"; // Sistema cyan
        
        consoleDiv.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
        console.log(`[${type}] ${msg}`);
    }

    // --- CHEQUEO DE COMPATIBILIDAD ---
    window.onload = function() {
        const a = document.createElement('audio');
        log("Probando soporte de audio del navegador...", "sys");
        const mp3 = a.canPlayType('audio/mpeg');
        const ogg = a.canPlayType('audio/ogg');
        const wav = a.canPlayType('audio/wav');
        
        log(`Soporte MP3: ${mp3 ? mp3 : "NO"}`, mp3 ? "info" : "error");
        log(`Soporte OGG: ${ogg ? ogg : "NO"}`, "info");
        log(`Soporte WAV: ${wav ? wav : "NO"}`, "info");
        
        if(!mp3) {
            log("‚ö†Ô∏è TU NAVEGADOR NO SOPORTA MP3. Usa archivos .WAV o .OGG", "error");
        } else {
            log("Selecciona un archivo para empezar.", "sys");
        }
    };

    // --- CARGA DE AUDIO ---
    const fileInput = document.getElementById('audioFile');

    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Limpiar logs anteriores
        consoleDiv.innerHTML = "";
        log(`Cargando: "${file.name}"`, "info");
        log(`Tipo: ${file.type}`, "info");

        // Reiniciar estado
        btnStart.style.display = 'none';
        
        try {
            const objectUrl = URL.createObjectURL(file);
            audioPlayer.src = objectUrl;
            audioPlayer.load(); 
        } catch (err) {
            log(`Error creando URL: ${err.message}`, "error");
        }
    });

    // --- EVENTOS DEL REPRODUCTOR ---
    audioPlayer.addEventListener('canplay', () => {
        log("‚úÖ Archivo aceptado. Listo para tocar.", "info");
        btnStart.style.display = 'inline-block';
    });
    
    audioPlayer.addEventListener('error', (e) => {
        const err = audioPlayer.error;
        let msg = "Desconocido";
        if(err) {
            if(err.code === 4) msg = "FORMATO NO SOPORTADO (SRC_NOT_SUPPORTED).";
            if(err.code === 3) msg = "DECODIFICACI√ìN FALLIDA.";
        }
        log(`‚ùå ERROR FATAL: ${msg}`, "error");
        log("üí° SOLUCI√ìN: Prueba convertir tu audio a formato .WAV", "warn");
    });

    // --- BOT√ìN DE INICIO ---
    btnStart.addEventListener('click', () => {
        audioPlayer.play()
            .then(() => {
                log("üé∂ Reproduciendo...", "info");
                btnStart.style.display = 'none';
            })
            .catch(err => {
                log(`Error Play: ${err.message}`, "error");
            });
    });

    // --- L√ìGICA DE DIRECTOR ---
    function onResults(results) {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            for (const [index, landmarks] of results.multiHandLandmarks.entries()) {
                const label = results.multiHandedness[index].label;
                // Selfie mode: Right = Tu mano derecha
                const isRight = label === 'Right';
                const isLeft = label === 'Left';

                const color = isRight ? '#ffa726' : '#29b6f6';
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: color, lineWidth: 3});
                drawLandmarks(canvasCtx, landmarks, {color: '#fff', lineWidth: 1, radius: 3});

                // Mano Izquierda: Volumen
                if (isLeft) {
                    targetVol = Math.max(0, Math.min(1, 1 - landmarks[0].y));
                    canvasCtx.fillStyle = color;
                    canvasCtx.fillText(`Vol: ${(targetVol*100).toFixed(0)}%`, landmarks[0].x * canvasElement.width, landmarks[0].y * canvasElement.height);
                }

                // Mano Derecha: Velocidad
                if (isRight) {
                    const x = landmarks[0].x;
                    const y = landmarks[0].y;
                    const dist = Math.sqrt(Math.pow(x - prevX, 2) + Math.pow(y - prevY, 2));
                    prevX = x; prevY = y;

                    let velocity = dist * 35; 
                    targetSpd = Math.max(0.1, Math.min(3.0, 0.5 + velocity));
                    
                    canvasCtx.fillStyle = color;
                    canvasCtx.fillText(`x${targetSpd.toFixed(1)}`, x * canvasElement.width, y * canvasElement.height);
                }
            }
        } else {
            targetSpd = 1.0;
        }

        // Suavizado
        currVol += (targetVol - currVol) * LERP;
        currSpd += (targetSpd - currSpd) * LERP;

        if (!audioPlayer.paused) {
            audioPlayer.volume = currVol;
            if (currSpd < 0.1) currSpd = 0.1;
            audioPlayer.playbackRate = currSpd;

            // UI
            volBar.style.width = (currVol * 100) + "%";
            volTxt.innerText = Math.round(currVol * 100) + "%";
            let spdP = (currSpd / 3) * 100;
            spdBar.style.width = Math.min(spdP, 100) + "%";
            spdTxt.innerText = currSpd.toFixed(1) + "x";
        }
        canvasCtx.restore();
    }

    // --- C√ÅMARA ---
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    hands.onResults(onResults);

    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        const camera = new Camera(videoElement, {
            onFrame: async () => { try { await hands.send({image: videoElement}); } catch(e){} },
            width: 640, height: 480
        });
        camera.start().catch(e => log(`Error C√°mara: ${e.message}`, "error"));
    } else {
        log("C√°mara no soportada.", "error");
    }
</script>

</body>
</html>
